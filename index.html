<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Sylvaria News Service</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Segoe UI', Inter, sans-serif;
      margin: 0;
      color: #fff;
      background: radial-gradient(circle at top left, #1a1a2e, #16213e, #0f3460);
      overflow-x:hidden;
    }
    header {
      backdrop-filter: blur(14px);
      background: rgba(255,255,255,0.06);
      padding: 1.2rem 2rem;
      display:flex; justify-content:space-between; align-items:center;
    }
    nav {
      display:flex; justify-content:center; gap:1rem;
      background: rgba(255,255,255,0.08); padding:0.8rem;
    }
    nav a { color:#fff; text-decoration:none; font-weight:600; }
    nav a:hover { color:#3ef0ff; }

    #content { display:grid; grid-template-columns:320px 1fr; gap:1.6rem; padding:1.6rem; }
    .card {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(14px);
      border-radius:16px; padding:1rem; margin-bottom:1rem;
    }
    input, textarea, select, button {
      margin:6px 0; padding:0.7rem; width:90%; max-width:280px;
      border-radius:10px; border:1px solid rgba(255,255,255,0.2);
      background: rgba(0,0,0,0.25); color:#fff;
    }
    .button {
      background: linear-gradient(135deg, #22c55e, #76e0a1);
      color:#000; font-weight:700; border:none; border-radius:12px;
      cursor:pointer; padding:0.8rem 1rem;
    }
    .button:hover { filter:brightness(1.1); }
    .article-card {
      display:flex; flex-direction:column; gap:0.6rem;
      margin-bottom:1rem;
    }
    .article-card img {
      width:100%; max-height:200px; object-fit:cover; border-radius:12px;
    }
    .badge { background:rgba(255,255,255,0.16); padding:0.2rem 0.5rem; border-radius:999px; font-size:0.8rem; }
    footer { text-align:center; margin:1rem; color:rgba(255,255,255,0.7); }
  </style>
</head>
<body>
  <header>
    <div class="title">üì∞ Sylvaria News Service</div>
    <div>
      <select id="themeSelect" onchange="changeTheme(this.value)">
        <option value="summer" selected>Summer</option>
        <option value="spring">Spring</option>
        <option value="autumn">Autumn</option>
        <option value="winter">Winter</option>
      </select>
    </div>
  </header>

  <nav>
    <a href="#" onclick="showChannel('Culture')">Culture</a>
    <a href="#" onclick="showChannel('Economy')">Economy</a>
    <a href="#" onclick="showChannel('Politics')">Politics</a>
    <a href="#" onclick="showChannel('Tech')">Tech</a>
    <a href="#" onclick="showAllApproved()">All</a>
  </nav>

  <div id="content">
    <div>
      <div class="card" id="loginCard">
        <h3>Login</h3>
        <button class="button" onclick="googleLogin()">Sign in with Google (Citizen)</button>
        <hr>
        <h4>Creator Login</h4>
        <input id="loginUser" placeholder="Username">
        <input id="loginPass" type="password" placeholder="Password">
        <button class="button" onclick="login()">Login</button>
      </div>

      <div class="card" id="signupCard">
        <h3>Sign Up (Creator)</h3>
        <input id="signupUser" placeholder="Username">
        <input id="signupPass" type="password" placeholder="Password">
        <input id="signupDisplayName" placeholder="Display name">
        <textarea id="signupDescription" placeholder="Short description/bio"></textarea>
        <input id="signupPronouns" placeholder="Pronouns (optional)">
        <input id="signupProfilePic" placeholder="Profile picture URL (optional)">
        <button class="button" onclick="signup()">Request Creator Account</button>
      </div>
    </div>

    <div>
      <div class="card"><h2>Latest Articles</h2><div id="articleList"></div></div>
      <div class="card"><h3>Trending Topics</h3><div id="trendingList"></div></div>
    </div>
  </div>

  <footer>¬© Sylvaria News 2026 ‚Ä¢ Colorful, modern, citizen-powered</footer>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC73vbdzIj2xjQtZ62a0skU8vvAXGJk-7Y",
      authDomain: "sylvaria-news.firebaseapp.com",
      projectId: "sylvaria-news",
      storageBucket: "sylvaria-news.firebasestorage.app",
      messagingSenderId: "33007586013",
      appId: "1:33007586013:web:a8361baa22b3d31e57e934",
      measurementId: "G-RT3LMNP913"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const googleProvider = new firebase.auth.GoogleAuthProvider();

    let currentUser = null;
    let isCreator = false;
    let isAdmin = false;

    function changeTheme(theme){
      if(theme==="summer"){ document.body.style.background="radial-gradient(circle at top left,#0b1736,#162a5b,#1f3a73)"; }
      if(theme==="spring"){ document.body.style.background="radial-gradient(circle at top left,#0d1f1d,#1f3b2d,#285943)"; }
      if(theme==="autumn"){ document.body.style.background="radial-gradient(circle at top left,#1a0f06,#3b220f,#5a3316)"; }
      if(theme==="winter"){ document.body.style.background="radial-gradient(circle at top left,#0a1220,#122036,#1a2c4a)"; }
    }

    async function googleLogin(){
      try {
        const result = await auth.signInWithPopup(googleProvider);
        const user = result.user;
        currentUser = user.displayName || user.email;
        alert("Signed in as citizen: " + currentUser);
      } catch(e){ alert("Google sign-in failed: " + e.message); }
    }

    async function signup(){
      const user = document.getElementById("signupUser").value.trim();
      const pass = document.getElementById("signupPass").value.trim();
      const displayName = document.getElementById("signupDisplayName").value.trim();
      const description = document.getElementById("signupDescription").value.trim();
      const pronouns = document.getElementById("signupPronouns").value.trim();
      const profilePic = document.getElementById("signupProfilePic").value.trim();
      if(!user || !pass || !displayName || !description){
        alert("Username, password, display name, and description required.");
        return;
      }
      await db.collection("users").add({
        user, pass, role:"creator", approved:false, created:new Date(),
        displayName, description, pronouns: pronouns||null, profilePic: profilePic||null,
        followersCount:0
      });
      alert("Creator signup submitted. Await admin approval.");
    }

    async function login(){
      const user = document.getElementById("loginUser").value.trim();
      const pass = document.getElementById("loginPass").value.trim();
      if(user==="GOV" && pass==="Securegov"){
        isAdmin=true; currentUser="GOV";
        alert("Admin logged in.");
        return;
      }
    const snapshot = await db.collection("users")
      .where("user","==",user)
      .where("pass","==",pass)
      .where("approved","==",true)
      .where("role","==","creator").get();

    if(!snapshot.empty){
      isCreator = true; isAdmin = false; currentUser = user;
      alert("Creator logged in.");
    } else {
      alert("Login failed or not approved yet.");
    }
  }

  // Article submission (preview-only model with optional image URL)
  async function submitArticle(){
    if(!isCreator){ alert("Login as a Creator to submit."); return; }
    const title = (document.getElementById("articleTitle")?.value||"").trim();
    const content = (document.getElementById("articleContent")?.value||"").trim();
    const channel = (document.getElementById("articleChannel")?.value)||"Culture";
    const imageUrl = (document.getElementById("articleImageUrl")?.value||"").trim();

    if(!title || !content){ alert("Title and content required."); return; }

    await db.collection("articles").add({
      title,
      content,
      channel,
      imageUrl: imageUrl || null,
      author: currentUser || "Unknown",
      approved: false,      // Admin approval comes in Part 2
      likes: 0,
      created: new Date()
    });

    if(document.getElementById("articleTitle")) document.getElementById("articleTitle").value="";
    if(document.getElementById("articleContent")) document.getElementById("articleContent").value="";
    if(document.getElementById("articleImageUrl")) document.getElementById("articleImageUrl").value="";

    alert("Article submitted for review.");
  }

  // Feed: show approved articles and render preview cards
  async function showChannel(channel){
    const snap = await db.collection("articles")
      .where("channel","==",channel)
      .where("approved","==",true).orderBy("created","desc").get();
    renderArticlePreviews(snap);
  }

  async function showAllApproved(){
    const snap = await db.collection("articles")
      .where("approved","==",true).orderBy("created","desc").get();
    renderArticlePreviews(snap);
  }

  function renderArticlePreviews(snapshot){
    const list = document.getElementById("articleList");
    list.innerHTML = "";
    if(snapshot.empty){
      list.innerHTML = "<p>No articles yet.</p>";
      return;
    }
    snapshot.forEach(docSnap=>{
      const d = docSnap.data();
      const id = docSnap.id;
      const excerpt = (d.content||"").length > 160 ? (d.content.slice(0,160) + "‚Ä¶") : d.content || "";
      const imgHTML = d.imageUrl ? `<img src="${d.imageUrl}" alt="article image">` : "";
      const card = document.createElement("div");
      card.className = "card article-card";
      card.innerHTML = `
        ${imgHTML}
        <h3>${d.title}</h3>
        <div class="badge">By ${d.author || "Unknown"} ‚Ä¢ ${d.channel}</div>
        <p>${excerpt}</p>
        <a class="button" href="article.html?id=${id}">Read more</a>
      `;
      list.appendChild(card);
    });
  }

  // Trending topics (simple score: likes + count)
  async function refreshTrending(){
    const channels = ["Culture","Economy","Politics","Tech"];
    const container = document.getElementById("trendingList");
    const scores = [];
    for(const ch of channels){
      const snap = await db.collection("articles")
        .where("channel","==",ch).where("approved","==",true).get();
      let count=0, likes=0;
      snap.forEach(s=>{
        count++;
        likes += s.data().likes||0;
      });
      scores.push({channel:ch, count, likes, score: likes + count});
    }
    scores.sort((a,b)=> b.score - a.score);
    container.innerHTML = scores.map(s=>`
      <div class="badge" style="display:inline-block;margin:4px;">
        ${s.channel}: ${s.count} articles, ${s.likes} likes
      </div>
    `).join("");
  }

  // Expose globals for inline handlers
  window.changeTheme = changeTheme;
  window.googleLogin = googleLogin;
  window.signup = signup;
  window.login = login;

  window.submitArticle = submitArticle;
  window.showChannel = showChannel;
  window.showAllApproved = showAllApproved;
  window.refreshTrending = refreshTrending;

  // Initial load
  changeTheme(document.getElementById("themeSelect").value);
  showAllApproved();
  refreshTrending();
  // Optional: creator submission mini-form (added here so Part 1 can preview submission UX)
  // You can remove or replace this in Part 2‚Äôs creator portal.
  const latestCard = document.querySelector('#content > div:nth-child(2) .card');
  const submitBlock = document.createElement('div');
  submitBlock.className = 'card';
  submitBlock.innerHTML = `
    <h3>Quick Submit (Creator)</h3>
    <input id="articleTitle" placeholder="Title">
    <textarea id="articleContent" placeholder="Content (short excerpt recommended)"></textarea>
    <select id="articleChannel">
      <option value="Culture">Culture</option>
      <option value="Economy">Economy</option>
      <option value="Politics">Politics</option>
      <option value="Tech">Tech</option>
    </select>
    <input id="articleImageUrl" placeholder="Image URL (optional)">
    <button class="button" onclick="submitArticle()">Submit for Review</button>
  `;
  latestCard.parentNode.appendChild(submitBlock);
</script>

<!-- üîö END OF PART 1 ‚Äî Paste Part 2 Below This Line -->
<!-- PART 2: Creator pages, full article pages, topics, follow system, admin review -->

<!-- PART 2: Creator pages, full article pages, topics, follow system, admin review -->
<style>
  /* Part 2 UI additions */
  .container { padding: 1.6rem; }
  .grid-2 { display:grid; grid-template-columns: 1fr 360px; gap:1.6rem; }
  .flow { display:flex; flex-direction:column; gap:1rem; }
  .hero-img { width:100%; max-height:340px; object-fit:cover; border-radius:16px; }
  .pill { display:inline-block; padding:0.35rem 0.7rem; border-radius:999px; background:rgba(255,255,255,0.12); font-size:0.85rem; }
  .mute { color: rgba(255,255,255,0.75); }
  .row { display:flex; gap:0.6rem; align-items:center; flex-wrap:wrap; }
  .link { color:#3ef0ff; text-decoration:none; }
  .link:hover { text-decoration:underline; }
  .divider { height:1px; background:rgba(255,255,255,0.12); margin:0.8rem 0; }
</style>

<script>
  // Router: single-file ‚Äúpages‚Äù via query params
  // Supported:
  // - ?view=article&id=ARTICLE_ID
  // - ?view=creator&user=USERNAME[&topic=TOPIC]
  // - ?view=admin (admin dashboard)
  function getQuery(){
    const p = new URLSearchParams(window.location.search);
    return {
      view: p.get("view"),
      id: p.get("id"),
      user: p.get("user"),
      topic: p.get("topic")
    };
  }

  function clearMain(){
    const content = document.getElementById("content");
    content.innerHTML = "";
  }
  function mountMain(node){
    const content = document.getElementById("content");
    content.appendChild(node);
  }

  async function route(){
    const q = getQuery();
    if(q.view === "article" && q.id){
      await renderArticlePage(q.id);
    } else if(q.view === "creator" && q.user){
      await renderCreatorPage(q.user, q.topic);
    } else if(q.view === "admin"){
      await renderAdminPage();
    } else {
      // Homepage from Part 1 stays
    }
  }

  document.addEventListener("DOMContentLoaded", route);

  // Full Article Page
  async function renderArticlePage(articleId){
    clearMain();
    const doc = await db.collection("articles").doc(articleId).get();
    const wrap = document.createElement("div");
    wrap.className = "container grid-2";

    if(!doc.exists){
      wrap.innerHTML = `<div class="card"><h3>Article not found</h3><p>It may have been removed or never existed.</p></div>`;
      mountMain(wrap);
      return;
    }

    const d = doc.data();
    const left = document.createElement("div");
    left.className = "flow";
    left.innerHTML = `
      <div class="card">
        <div class="row">
          <a class="link" href="./">‚Üê Back to home</a>
          <span class="pill">${d.channel}</span>
          <span class="pill">By ${d.author || "Unknown"}</span>
        </div>
        <h2 style="margin-top:0.6rem;">${d.title}</h2>
        ${d.imageUrl ? `<img class="hero-img" src="${d.imageUrl}" alt="article image">` : ""}
        <div class="divider"></div>
        <p style="white-space:pre-wrap;">${d.content}</p>
        <div class="row" style="margin-top:0.6rem;">
          <button class="button" onclick="likeArticleFull('${articleId}')">üëç Like</button>
          <span class="badge" id="articleLikesCount">Likes: ${d.likes||0}</span>
        </div>
      </div>

      <div class="card">
        <h3>Comments</h3>
        <div class="row">
          <input id="fullCommentInput" placeholder="Add comment" style="flex:1; max-width:none;">
          <button class="button" onclick="addCommentFull('${articleId}')">Comment</button>
        </div>
        <div id="fullComments"></div>
      </div>
    `;

    const right = document.createElement("div");
    right.className = "flow";
    right.innerHTML = `
      <div class="card">
        <h3>Creator</h3>
        <p class="mute">View the creator‚Äôs profile and more.</p>
        <a class="button" href="?view=creator&user=${encodeURIComponent(d.author || "")}">Open creator page</a>
      </div>
      <div class="card">
        <h3>Related</h3>
        <div id="relatedList" class="flow"></div>
      </div>
    `;

    wrap.appendChild(left);
    wrap.appendChild(right);
    mountMain(wrap);

    await loadCommentsFull(articleId);

    const relSnap = await db.collection("articles")
      .where("channel","==",d.channel)
      .where("approved","==",true).orderBy("created","desc").limit(5).get();
    const relatedList = right.querySelector("#relatedList");
    relSnap.forEach(s=>{
      if(s.id === articleId) return;
      const rd = s.data();
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        ${rd.imageUrl ? `<img src="${rd.imageUrl}" style="width:100%;max-height:140px;object-fit:cover;border-radius:12px;">` : ""}
        <h4 style="margin:.5rem 0;">${rd.title}</h4>
        <p class="mute">${(rd.content||"").slice(0,120)}${(rd.content||"").length>120?"‚Ä¶":""}</p>
        <a class="button" href="?view=article&id=${s.id}">Read</a>
      `;
      relatedList.appendChild(el);
    });
  }

  async function likeArticleFull(id){
    const ref = db.collection("articles").doc(id);
    await ref.update({likes: firebase.firestore.FieldValue.increment(1)});
    const doc = await ref.get();
    document.getElementById("articleLikesCount").textContent = "Likes: " + (doc.data().likes||0);
  }
  async function addCommentFull(articleId){
    const input = document.getElementById("fullCommentInput");
    const text = (input.value||"").trim();
    if(!text) return;
    await db.collection("comments").add({
      articleId, user: (window.currentUser || "Anonymous"), text, timestamp: new Date()
    });
    input.value = "";
    await loadCommentsFull(articleId);
  }
  async function loadCommentsFull(articleId){
    const container = document.getElementById("fullComments");
    container.innerHTML = "";
    const snap = await db.collection("comments")
      .where("articleId","==",articleId)
      .orderBy("timestamp","asc").get();
    if(snap.empty){
      container.innerHTML = `<p class="mute">No comments yet.</p>`;
      return;
    }
    snap.forEach(s=>{
      const d = s.data();
      const item = document.createElement("div");
      item.className = "card";
      item.innerHTML = `<p><strong>${d.user}:</strong> ${d.text}</p>`;
      container.appendChild(item);
    });
  }

  // Creator Page with topics and follower-only content
  async function renderCreatorPage(username, topicFilter){
    clearMain();
    const userSnap = await db.collection("users")
      .where("user","==",username)
      .where("role","==","creator")
      .where("approved","==",true).limit(1).get();

    const wrap = document.createElement("div");
    wrap.className = "container grid-2";

    if(userSnap.empty){
      wrap.innerHTML = `<div class="card"><h3>Creator not found</h3></div>`;
      mountMain(wrap);
      return;
    }
    const doc = userSnap.docs[0];
    const creatorId = doc.id;
    const u = doc.data();

    const viewerKey = auth.currentUser?.uid || (window.isCreator ? ("creator:"+window.currentUser) : null);
    let isFollower = false;
    if(viewerKey){
      const followId = `${viewerKey}__${creatorId}`;
      const fRef = db.collection("follows").doc(followId);
      const f = await fRef.get();
      isFollower = f.exists;
    }

    const left = document.createElement("div");
    left.className = "flow";
    left.innerHTML = `
      <div class="card" style="display:flex;gap:1rem;align-items:center;">
        <img src="${u.profilePic || 'https://via.placeholder.com/72'}" alt="profile" style="width:72px;height:72px;border-radius:14px;object-fit:cover;border:1px solid rgba(255,255,255,0.2)">
        <div>
          <h2 style="margin:0">${u.displayName}</h2>
          <div class="row">
            <span class="pill">${u.pronouns || "‚Äî"}</span>
            <span class="pill">Followers: <span id="creatorFollowersCount">${u.followersCount||0}</span></span>
          </div>
          <p class="mute" style="margin-top:.4rem">${u.description}</p>
          <div class="row" style="margin-top:.6rem;">
            <button class="button" onclick="toggleFollowOnCreator('${creatorId}')">${isFollower ? "Unfollow" : "Follow"}</button>
            ${(window.isCreator && window.currentUser===username) ? `<a class="button" href="#" onclick="openTopicCreator('${creatorId}');return false;">Manage topics</a>` : ""}
          </div>
        </div>
      </div>

      <div id="topicsArea" class="card">
        <h3>Topics</h3>
        <div id="topicList" class="flow"></div>
      </div>

      <div id="publicArticlesArea" class="card">
        <h3>Public articles${topicFilter ? ` in "${topicFilter}"` : ""}</h3>
        <div id="publicList" class="flow"></div>
      </div>

      <div id="followersOnlyArea" class="card">
        <h3>Followers-only articles${topicFilter ? ` in "${topicFilter}"` : ""}</h3>
        <div id="foList" class="flow"></div>
      </div>
    `;

    const right = document.createElement("div");
    right.className = "flow";
    right.innerHTML = `
      ${(window.isCreator && window.currentUser===username) ? `
      <div class="card">
        <h3>New article</h3>
        <input id="creatorArticleTitle" placeholder="Title">
        <textarea id="creatorArticleContent" placeholder="Content"></textarea>
        <select id="creatorArticleChannel">
          <option value="Culture">Culture</option>
          <option value="Economy">Economy</option>
          <option value="Politics">Politics</option>
          <option value="Tech">Tech</option>
        </select>
        <input id="creatorArticleImageUrl" placeholder="Image URL (optional)">
        <select id="creatorArticleAud" title="Audience">
          <option value="public" selected>Public</option>
          <option value="followers">Followers only</option>
        </select>
        <select id="creatorArticleTopic" title="Topic (optional)"></select>
        <button class="button" onclick="submitArticleFromCreator('${creatorId}')">Submit for review</button>
      </div>` : `
      <div class="card">
        <h3>About</h3>
        <p class="mute">This creator shares public and follower-only articles. Follow to see more.</p>
      </div>`}
    `;

    wrap.appendChild(left);
    wrap.appendChild(right);
    mountMain(wrap);

    await renderCreatorTopics(creatorId, username, topicFilter);
    await renderCreatorArticles(creatorId, username, "public", "publicList", topicFilter);

    if(isFollower){
      await renderCreatorArticles(creatorId, username, "followers", "foList", topicFilter);
    } else {
      document.getElementById("foList").innerHTML = `<p class="mute">Follow to see follower-only content.</p>`;
    }
  }

  async function renderCreatorTopics(creatorId, username, topicFilter){
    const list = document.getElementById("topicList");
    list.innerHTML = "";
    const sel = document.getElementById("creatorArticleTopic");
    if(sel) sel.innerHTML = `<option value="">No topic</option>`;

    const snap = await db.collection("topics")
      .where("ownerDocId","==",creatorId).orderBy("created","desc").get();
    if(snap.empty){
      list.innerHTML = `<p class="mute">No topics yet.</p>`;
      return;
    }
    snap.forEach(s=>{
      const t = s.data();
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        ${t.imageUrl ? `<img src="${t.imageUrl}" style="width:100%;max-height:140px;object-fit:cover;border-radius:12px;">` : ""}
        <h4 style="margin:.4rem 0;">${t.title}</h4>
        <p class="mute">${t.description||""}</p>
        <div class="row">
          <a class="button" href="?view=creator&user=${encodeURIComponent(username)}&topic=${encodeURIComponent(t.title)}">Open</a>
          ${(window.isCreator && window.currentUser===username) ? `<button class="button" onclick="deleteTopic('${s.id}','${creatorId}','${username}')">Delete</button>` : ""}
        </div>
      `;
      list.appendChild(el);
      if(sel){
        const opt = document.createElement("option");
        opt.value = t.title; opt.textContent = t.title;
        sel.appendChild(opt);
      }
    });
  }

  async function renderCreatorArticles(creatorDocId, username, audience, mountId, topicFilter){
    const list = document.getElementById(mountId);
    list.innerHTML = "";
    const snap = await db.collection("articles")
      .where("author","==",username)
      .where("approved","==",true)
      .where("audience","==",audience)
      .orderBy("created","desc").get();
    let any = false;
    snap.forEach(s=>{
      const d = s.data();
      if(topicFilter && d.topic !== topicFilter) return;
      any = true;
      const el = document.createElement("div");
      el.className = "card";
      el.innerHTML = `
        ${d.imageUrl ? `<img src="${d.imageUrl}" style="width:100%;max-height:160px;object-fit:cover;border-radius:12px;">` : ""}
        <h4 style="margin:.4rem 0;">${d.title}</h4>
        <p class="mute">${(d.content||"").slice(0,160)}${(d.content||"").length>160?"‚Ä¶":""}</p>
        <a class="button" href="?view=article&id=${s.id}">Read</a>
      `;
      list.appendChild(el);
    });
    if(!any){
      list.innerHTML = `<p class="mute">No articles yet.</p>`;
    }
  }

  // Follow/unfollow creators (citizens and creators can follow)
  async function toggleFollowOnCreator(creatorDocId){
    const viewerKey = auth.currentUser?.uid || (window.isCreator ? ("creator:"+window.currentUser) : null);
    if(!viewerKey){
      alert("Sign in (Google or Creator) to follow.");
      return;
    }
    const followId = `${viewerKey}__${creatorDocId}`;
    const ref = db.collection("follows").doc(followId);
    const exists = await ref.get();
    if(exists.exists){
      await ref.delete();
      await db.collection("users").doc(creatorDocId)
        .update({followersCount: firebase.firestore.FieldValue.increment(-1)});
    } else {
      await ref.set({ viewerKey, creatorDocId, timestamp: new Date() });
      await db.collection("users").doc(creatorDocId)
        .update({followersCount: firebase.firestore.FieldValue.increment(1)});
    }
    const doc = await db.collection("users").doc(creatorDocId).get();
    const d = doc.data();
    const el = document.getElementById("creatorFollowersCount");
    if(el) el.textContent = d.followersCount || 0;
  }

  // Topic creation (simple prompts for single-file)
  async function openTopicCreator(creatorDocId){
    const title = prompt("Topic title:");
    if(!title) return;
    const description = prompt("Topic description (optional):") || "";
    const imageUrl = prompt("Topic image URL (optional):") || "";
    await db.collection("topics").add({
      ownerDocId: creatorDocId,
      title,
      description,
      imageUrl: imageUrl || null,
      created: new Date()
    });
    const q = getQuery();
    await renderCreatorPage(q.user, q.topic);
  }
  async function deleteTopic(topicId, creatorDocId, username){
    await db.collection("topics").doc(topicId).delete();
    await renderCreatorPage(username);
  }

  // Creator article submission from creator page
  async function submitArticleFromCreator(creatorDocId){
    if(!window.isCreator){ alert("Login as a Creator to submit."); return; }
    const title = (document.getElementById("creatorArticleTitle").value||"").trim();
    const content = (document.getElementById("creatorArticleContent").value||"").trim();
    const channel = document.getElementById("creatorArticleChannel").value;
    const imageUrl = (document.getElementById("creatorArticleImageUrl").value||"").trim();
    const audience = document.getElementById("creatorArticleAud").value || "public";
    const topic = (document.getElementById("creatorArticleTopic").value||"").trim();

    if(!title || !content){ alert("Title and content required."); return; }

    await db.collection("articles").add({
      title,
      content,
      channel,
      imageUrl: imageUrl || null,
      author: window.currentUser,
      audience,
      topic: topic || null,
      approved: false,
      likes: 0,
      created: new Date()
    });

    document.getElementById("creatorArticleTitle").value="";
    document.getElementById("creatorArticleContent").value="";
    document.getElementById("creatorArticleImageUrl").value="";
    alert("Article submitted for review.");
  }

  // Admin page (render when ?view=admin)
  async function renderAdminPage(){
    clearMain();
    const wrap = document.createElement("div");
    wrap.className = "container grid-2";

    const left = document.createElement("div");
    const right = document.createElement("div");

    left.innerHTML = `
      <div class="card">
        <h2>Admin Panel</h2>
        <p class="mute">Approve creators and articles. Log in as GOV/Securegov first.</p>
        <div class="row"><a class="link" href="./">‚Üê Home</a></div>
      </div>
      <div class="card"><h3>Pending creators</h3><div id="pendingCreators" class="flow"></div></div>
      <div class="card"><h3>Article review queue</h3><div id="articleQueue" class="flow"></div></div>
    `;

    right.innerHTML = `<div class="card"><h3>Stats</h3><div id="adminStatsContent" class="flow"></div></div>`;

    wrap.appendChild(left);
    wrap.appendChild(right);
    mountMain(wrap);

    await loadPendingCreators();
    await loadArticleQueueAdmin();
    await renderAdminStats();
  }

  async function loadPendingCreators(){
    const mount = document.getElementById("pendingCreators");
    mount.innerHTML = "";
    const snap = await db.collection("users").where("role","==","creator").where("approved","==",false).get();
    if(snap.empty){ mount.innerHTML = `<p class="mute">No pending creators.</p>`; return; }
    snap.forEach(s=>{
      const u = s.data();
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h4>${u.displayName} <span class="pill">${u.user}</span></h4>
        <p class="mute">${u.description}</p>
        <div class="row">
          <button class="button" onclick="approveCreator('${s.id}')">Approve</button>
          <button class="button" onclick="rejectCreator('${s.id}')">Reject</button>
        </div>
      `;
      mount.appendChild(card);
    });
  }
  async function approveCreator(docId){
    if(!window.isAdmin){ alert("Admin login required (GOV/Securegov)."); return; }
    await db.collection("users").doc(docId).update({approved:true});
    await loadPendingCreators();
    alert("Creator approved.");
  }
  async function rejectCreator(docId){
    if(!window.isAdmin){ alert("Admin login required (GOV/Securegov)."); return; }
    await db.collection("users").doc(docId).delete();
    await loadPendingCreators();
    alert("Creator rejected.");
  }

  async function loadArticleQueueAdmin(){
    const mount = document.getElementById("articleQueue");
    mount.innerHTML = "";
    const snap = await db.collection("articles").where("approved","==",false).orderBy("created","desc").get();
    if(snap.empty){ mount.innerHTML = `<p class="mute">No articles pending.</p>`; return; }
    snap.forEach(s=>{
      const d = s.data();
      const card = document.createElement("div");
      card.className = "card";
      card.innerHTML = `
        <h4>${d.title} <span class="pill">${d.channel}</span> <span class="pill">${d.audience||'public'}</span></h4>
        <p class="mute">By ${d.author || 'Unknown'}</p>
        <p class="mute">${(d.content||"").slice(0,200)}${(d.content||"").length>200?"‚Ä¶":""}</p>
        <div class="row">
          <button class="button" onclick="approveArticleAdmin('${s.id}')">Approve</button>
          <button class="button" onclick="rejectArticleAdmin('${s.id}')">Reject</button>
          <a class="button" href="?view=article&id=${s.id}">Preview</a>
        </div>
      `;
      mount.appendChild(card);
    });
  }
  async function approveArticleAdmin(id){
    if(!window.isAdmin){ alert("Admin login required (GOV/Securegov)."); return; }
    await db.collection("articles").doc(id).update({approved:true, approvedAt:new Date(), approvedBy:"GOV"});
    await loadArticleQueueAdmin();
    alert("Article approved.");
  }
  async function rejectArticleAdmin(id){
    if(!window.isAdmin){ alert("Admin login required (GOV/Securegov)."); return; }
    await db.collection("articles").doc(id).delete();
    await loadArticleQueueAdmin();
    alert("Article rejected.");
  }

  async function renderAdminStats(){
    const mount = document.getElementById("adminStatsContent");
    const usersSnap = await db.collection("users").get();
    const creatorsSnap = await db.collection("users").where("role","==","creator").get();
    const pendingSnap = await db.collection("users").where("role","==","creator").where("approved","==",false).get();
    const articlesSnap = await db.collection("articles").get();
    const approvedSnap = await db.collection("articles").where("approved","==",true).get();
    mount.innerHTML = `
      <div class="card"><strong>Total users:</strong> ${usersSnap.size}</div>
      <div class="card"><strong>Creators:</strong> ${creatorsSnap.size}</div>
      <div class="card"><strong>Pending creators:</strong> ${pendingSnap.size}</div>
      <div class="card"><strong>Total articles:</strong> ${articlesSnap.size}</div>
      <div class="card"><strong>Approved articles:</strong> ${approvedSnap.size}</div>
    `;
  }

  // Homepage preview like bump (kept for consistency)
  async function likeArticle(id){
    const ref = db.collection("articles").doc(id);
    await ref.update({likes: firebase.firestore.FieldValue.increment(1)});
    if(typeof refreshTrending === "function") refreshTrending();
  }

  // Expose Part 2 APIs
  window.route = route;
  window.renderArticlePage = renderArticlePage;
  window.renderCreatorPage = renderCreatorPage;
  window.likeArticleFull = likeArticleFull;
  window.addCommentFull = addCommentFull;
  window.toggleFollowOnCreator = toggleFollowOnCreator;
  window.openTopicCreator = openTopicCreator;
  window.deleteTopic = deleteTopic;
  window.submitArticleFromCreator = submitArticleFromCreator;
  window.approveCreator = approveCreator;
  window.rejectCreator = rejectCreator;
  window.approveArticleAdmin = approveArticleAdmin;
  window.rejectArticleAdmin = rejectArticleAdmin;
</script>
</body>
</html>
